---
title: 虚拟内存——Linux 进程虚拟内存布局概述
categories:
  - 笔记
tags:
  - 默认标签
toc: true
comments: true
description: ''
date: 2025-12-06 14:57:44
author: 土土
updated:
plugins:
  - mathjax
---
本篇笔记记录 Linux 进程的虚拟内存体系结构，详细阐述了内核虚拟内存和进程虚拟内存的区域划分、数据结构以及它们在内存管理中的作用。
<!-- more -->
## Linux 进程虚拟内存布局概述

Linux 系统为每个**进程**都创建了一个**独立的虚拟内存空间**。这个虚拟地址空间通常是 $0$ 到 $2^{64}-1$ (对于 64 位系统) 或 $0$ 到 $2^{32}-1$ (对于 32 位系统)。分为两个部分

1.  **内核虚拟内存 (Kernel Virtual Memory)**：位于虚拟地址空间的高位，供操作系统内核使用。
2.  **进程虚拟内存 (Process Virtual Memory)**：通常位于虚拟地址空间的低位，包含用户程序运行所需的数据和代码。

## 内核虚拟内存区域

这部分位于虚拟地址空间的高位，供内核使用，并且**其内容对所有进程是“一样”或“相关”的**。

### 1. 对每个进程都不同（私有部分）

* **与进程相关的数据结构**：
    * **页表**：记录了当前进程**虚拟地址到物理地址**的映射关系，**每个进程都有自己独立的页表**。
    * **`task` 结构**：进程描述符，包含了进程 ID (PID)、状态、打开的文件等关键信息。
    * **`mm` 结构**：内存管理结构，描述了进程的**整个虚拟地址空间布局**（如各内存段的起始/结束地址）。
    * **内核栈 (Kernel Stack)**：进程**从用户态切换到内核态**（如进行系统调用）时使用的栈，与用户栈是分开的。

任务结构 task_struct 中的一个条目 mm 指向 mm_struct（描述虚拟内存的当前状态），其中的 pgd 指向第一级页表的基址， mmap 指向链表 vm_area_structs。  
每个 vm_area_structs 描述当前虚拟地址空间的一个区域/段。
- vm_end, vm_start: 指向这个区域的起始与终点。
- vm_prot: 所有页的读写权限。
- vm_flags: 是否共享。
- vm_next: 链表中下一个区域。

缺页异常处理中，未分配 -> 段错误；权限错误 -> 保护异常；未缓存 -> 按需页面调度。

### 2. 对每个进程都一样（共享部分）

这部分包含内核代码和数据，**所有进程的虚拟地址都映射到相同的物理内存地址**，实现了对内核资源的共享访问。

* **物理内存**：用于映射到实际的物理内存页。
* **内核代码和数据**：包括内核的可执行代码和全局数据结构。

## 进程虚拟内存区域

这部分是**每个进程独有的**，包含了用户程序执行的关键组成部分。地址通常从低位开始向上增长。

| 区域名称 | 地址 | 作用及特点 |
| :--- | :--- | :--- | 
| **用户栈 (User Stack)** | 地址较高，由 `%rsp` 指针控制 | 存放**局部变量**、**函数参数**、**返回地址**等。**从高地址向低地址增长**。 |
| **共享库的内存映射区域** | 堆上方 | 存放通过 **`mmap`** 系统调用映射的文件或**共享库**（如 `.so` 文件）。|
| **运行时堆 (Heap)** | 紧邻未初始化数据段上方，由 `brk` 指针控制 | 存放程序运行时**动态分配**的内存（如使用 **`malloc`** 或 **`new`**）。**从低地址向高地址增长**。|
| **未初始化数据段 (.bss)** | 紧邻已初始化数据段上方 | 存放程序中**未初始化**的全局变量和静态变量。在程序加载时，操作系统将其初始化为 **0**。 |
| **已初始化数据段 (.data)** | 紧邻代码段上方 | 存放程序中**已初始化**的全局变量和静态变量。 |
| **代码段 (.text)** | $0$ (或靠近 $0$ 的低地址)| 存放**可执行的机器指令**。通常是**只读**的，以防止程序意外修改自身代码。 |

* **$0\text{x}4000000$**: 常见的 64 位 Linux ELF 可执行文件的**基地址**，代码段通常从这里开始。
> Executable and Linkable Format, 是 Linux/Unix 系统中使用的可执行文件格式标准
* **`brk`**: **堆的边界指针**。`malloc` 分配堆内存时会移动 `brk`。
* **`%rsp`**: **栈指针寄存器**。指向当前栈帧的顶部，栈向低地址增长。
